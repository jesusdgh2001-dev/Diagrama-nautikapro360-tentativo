<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>NautikaPro360 - Flujo en 4 Fases</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #0f0f1a;
            color: #fff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        #ui-container {
            position: absolute;
            pointer-events: none;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
        }

        #nav-bar {
            position: absolute;
            bottom: 30px;
            width: 100%;
            text-align: center;
            pointer-events: auto;
            z-index: 20;
        }

        button {
            background: rgba(20, 20, 30, 0.8);
            border: 2px solid #fff;
            color: #fff;
            padding: 12px 25px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 30px;
            margin: 0 15px;
            transition: 0.3s;
            text-transform: uppercase;
            font-weight: bold;
            letter-spacing: 1px;
        }

        button:hover {
            background: #fff;
            color: #000;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.6);
        }

        button:disabled {
            border-color: #555;
            color: #555;
            background: rgba(10, 10, 10, 0.8);
            cursor: not-allowed;
            box-shadow: none;
        }

        #info-card {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 400px;
            background: rgba(15, 15, 25, 0.95);
            border-left: 4px solid #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
            pointer-events: auto;
            transition: all 0.3s;
        }

        h1 {
            margin: 0 0 5px 0;
            font-size: 22px;
            color: #fff;
        }

        h2 {
            margin: 0 0 15px 0;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.9;
            font-weight: 800;
        }

        p {
            font-size: 15px;
            line-height: 1.5;
            color: #ccc;
            margin-bottom: 0;
        }

        #phase-legend {
            position: absolute;
            top: 20px;
            right: 20px;
            text-align: right;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .legend-item {
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 13px;
            font-weight: bold;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: opacity 0.3s;
            opacity: 0.4;
        }

        .legend-active {
            opacity: 1;
            transform: scale(1.05);
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.2);
        }
    </style>
    <!-- Import maps polyfill -->
    <script async src="https://unpkg.com/es-module-shims@1.8.0/dist/es-module-shims.js"></script>
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>

<body>
    <div id="ui-container">
        <div id="info-card">
            <h2 id="step-phase" style="color:#aaa">Bienvenido</h2>
            <h1 id="step-title">Vista General</h1>
            <div style="height: 1px; background: rgba(255,255,255,0.1); margin: 15px 0;"></div>
            <p id="step-desc">Este diagrama muestra el flujo de negocio de NautikaPro360 dividido en 4 fases
                estrat√©gicas.<br><br>Usa "Siguiente" para recorrerlas.</p>
        </div>

        <div id="phase-legend">
            <div id="leg-setup" class="legend-item" style="color:#3498db; border-color:#3498db">1. CONFIGURACI√ìN</div>
            <div id="leg-comm" class="legend-item" style="color:#9b59b6; border-color:#9b59b6">2. COMERCIAL</div>
            <div id="leg-ops" class="legend-item" style="color:#e67e22; border-color:#e67e22">3. OPERACIONES</div>
            <div id="leg-end" class="legend-item" style="color:#2ecc71; border-color:#2ecc71">4. FINALIZACI√ìN</div>
        </div>

        <div id="nav-bar">
            <button id="btn-prev" disabled>‚ùÆ Anterior</button>
            <button id="btn-next">Siguiente ‚ùØ</button>
        </div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // --- Data Definition ---

        const PHASES = {
            setup: { name: "1. CONFIGURACI√ìN", color: 0x3498db, hex: "#3498db" },
            comm: { name: "2. COMERCIAL", color: 0x9b59b6, hex: "#9b59b6" },
            ops: { name: "3. OPERACIONES", color: 0xe67e22, hex: "#e67e22" },
            end: { name: "4. FINALIZACI√ìN", color: 0x2ecc71, hex: "#2ecc71" }
        };

        const TOUR_STEPS = [
            // Phase 1: Setup (Blue)
            { id: "reg_company", title: "Registro de Empresa", desc: "El admin registra la compa√±√≠a.", icon: "üè¢", phase: "setup" },
            { id: "add_users", title: "Agregar Empleados", desc: "Se crean usuarios internos.", icon: "üë•", phase: "setup" },
            { id: "config_comp", title: "Configuraci√≥n", desc: "Logos, datos y preferencias.", icon: "‚öôÔ∏è", phase: "setup" },
            { id: "add_ext", title: "Carga de Externos", desc: "Alta de Inspectores y Clientes.", icon: "üì•", phase: "setup" },
            { id: "grant_access", title: "Permisos de Acceso", desc: "Habilitaci√≥n de acceso a plataforma.", icon: "üîê", phase: "setup" },

            // Phase 2: Commercial (Purple)
            { id: "req_insp", title: "1. Solicitud", desc: "Comercial recibe y carga solicitud.", icon: "üì©", phase: "comm" },
            { id: "check_avail", title: "2. Disponibilidad", desc: "Verifica inspectores disponibles.", icon: "üîç", phase: "comm" },
            { id: "quote", title: "3. Cotizaci√≥n", desc: "Env√≠a propuesta al cliente.", icon: "üìù", phase: "comm" },
            { id: "client_dec", title: "4. Decisi√≥n", desc: "Cliente Acepta/Rechaza.", icon: "ü§î", phase: "comm" },
            { id: "nomination", title: "5. Nominaci√≥n", desc: "Genera la nominaci√≥n oficial.", icon: "üìú", phase: "comm" },
            { id: "confirm", title: "6. Confirmaci√≥n", desc: "Inspector acepta la nominaci√≥n. Fin de Fase Comercial.", icon: "‚úÖ", phase: "comm" },

            // Phase 3: Operations (Orange)
            { id: "tracking", title: "7. Seguimiento", desc: "Operaciones monitorea hitos (Inicio/Fin).", icon: "‚öì", phase: "ops" },
            { id: "timesheet", title: "8. Time Sheet", desc: "Inspector carga reporte de horas/gastos.", icon: "‚è±Ô∏è", phase: "ops" },
            { id: "receive_ts", title: "9. Recepci√≥n TS", desc: "Operaciones valida el Time Sheet.", icon: "üì•", phase: "ops" },

            // Phase 4: Completion (Green)
            { id: "stats", title: "10. Estad√≠sticas", desc: "Cierre, resumen y actualizaci√≥n de dashboards.", icon: "üìä", phase: "end" },
        ];

        // Layout: 4 Distinct Clusters
        const POSITIONS = {
            // Setup Cluster (Top Left)
            "reg_company": { x: -40, z: -20 },
            "add_users": { x: -30, z: -20 },
            "config_comp": { x: -30, z: -30 },
            "add_ext": { x: -20, z: -20 },
            "grant_access": { x: -10, z: -20 },

            // Commercial Cluster (Bottom Left to Center)
            "req_insp": { x: -40, z: 20 },
            "check_avail": { x: -30, z: 20 },
            "quote": { x: -20, z: 20 },
            "client_dec": { x: -10, z: 20 },
            "nomination": { x: 0, z: 20 },
            "confirm": { x: 10, z: 20 },

            // Operations Cluster (Center Right)
            "tracking": { x: 30, z: 0 },
            "timesheet": { x: 40, z: 0 },
            "receive_ts": { x: 50, z: 0 },

            // Completion Cluster (Far Right)
            "stats": { x: 70, z: 0 }
        };

        const CONNECTIONS = [
            ["reg_company", "add_users"],
            ["add_users", "config_comp"], ["add_users", "add_ext"], ["config_comp", "add_ext"],
            ["add_ext", "grant_access"],

            // Bridge Setup -> Comm
            ["grant_access", "req_insp", "faded"],

            ["req_insp", "check_avail"], ["check_avail", "quote"], ["quote", "client_dec"],
            ["client_dec", "nomination"], ["nomination", "confirm"],

            // Bridge Comm -> Ops
            ["confirm", "tracking"],

            ["tracking", "timesheet"], ["timesheet", "receive_ts"],

            // Bridge Ops -> End
            ["receive_ts", "stats"]
        ];

        // --- Scene Setup ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x0f0f1a);
        scene.fog = new THREE.Fog(0x0f0f1a, 20, 150);

        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 60, 80);

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;

        // --- Lighting ---
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambientLight);
        const dirLight = new THREE.DirectionalLight(0xffffff, 1);
        dirLight.position.set(20, 50, 20);
        scene.add(dirLight);

        // --- Visual Helpers ---
        function createTextTexture(text, bgColor) {
            const canvas = document.createElement('canvas');
            canvas.width = 128; canvas.height = 128;
            const ctx = canvas.getContext('2d');

            ctx.beginPath();
            ctx.arc(64, 64, 60, 0, Math.PI * 2);
            ctx.fillStyle = bgColor;
            ctx.fill();
            ctx.lineWidth = 4;
            ctx.strokeStyle = '#ffffff';
            ctx.stroke();

            ctx.font = '70px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillStyle = 'white';
            ctx.fillText(text, 64, 68);

            return new THREE.CanvasTexture(canvas);
        }

        function createZone(x, z, w, h, color) {
            const geo = new THREE.PlaneGeometry(w, h);
            const mat = new THREE.MeshBasicMaterial({ color: color, transparent: true, opacity: 0.15, side: THREE.DoubleSide });
            const mesh = new THREE.Mesh(geo, mat);
            mesh.rotation.x = -Math.PI / 2;
            mesh.position.set(x, -0.1, z);
            scene.add(mesh);

            // Border
            const edges = new THREE.EdgesGeometry(geo);
            const line = new THREE.LineSegments(edges, new THREE.LineBasicMaterial({ color: color, transparent: true, opacity: 0.5 }));
            line.rotation.x = -Math.PI / 2;
            line.position.set(x, -0.1, z);
            scene.add(line);
        }

        function createArrow(start, end, color = 0xaaaaaa) {
            const dir = new THREE.Vector3().subVectors(end, start);
            const length = dir.length() - 3.5; // Gap
            if (length <= 0) return;
            dir.normalize();
            const origin = start.clone().add(dir.clone().multiplyScalar(1.75));

            const group = new THREE.Group();

            // Line
            const lineGeo = new THREE.BufferGeometry().setFromPoints([origin, origin.clone().add(dir.clone().multiplyScalar(length))]);
            const lineMat = new THREE.LineBasicMaterial({ color: color, opacity: 0.6, transparent: true });
            const line = new THREE.LineSegments(lineGeo, lineMat);
            group.add(line);

            // Tip
            const tipGeo = new THREE.ConeGeometry(0.3, 0.8, 8);
            const tipMat = new THREE.MeshBasicMaterial({ color: color });
            const tip = new THREE.Mesh(tipGeo, tipMat);
            const tipPos = origin.clone().add(dir.clone().multiplyScalar(length));
            tip.position.copy(tipPos);
            tip.quaternion.setFromUnitVectors(new THREE.Vector3(0, 1, 0), dir);
            tip.rotateX(Math.PI / 2);
            group.add(tip);

            return group;
        }

        // --- Build Scene ---

        // 1. Zones
        createZone(-25, -22, 50, 30, PHASES.setup.color); // Setup
        createZone(-15, 20, 70, 20, PHASES.comm.color); // Commercial
        createZone(40, 0, 40, 20, PHASES.ops.color); // Ops
        createZone(70, 0, 20, 20, PHASES.end.color); // End

        // 2. Nodes
        const nodes = {};
        TOUR_STEPS.forEach(step => {
            const pos = POSITIONS[step.id];
            const phaseData = PHASES[step.phase];

            const tex = createTextTexture(step.icon, phaseData.hex);
            const mat = new THREE.SpriteMaterial({ map: tex });
            const sprite = new THREE.Sprite(mat);
            sprite.position.set(pos.x, 2, pos.z);
            sprite.scale.set(3.5, 3.5, 1);
            scene.add(sprite);
            nodes[step.id] = sprite;

            // Ground shadow
            const shadow = new THREE.Mesh(new THREE.CircleGeometry(1, 16), new THREE.MeshBasicMaterial({ color: 0x000000, transparent: true, opacity: 0.3 }));
            shadow.rotation.x = -Math.PI / 2;
            shadow.position.set(pos.x, 0, pos.z);
            scene.add(shadow);
        });

        // 3. Connections
        CONNECTIONS.forEach(conn => {
            const start = nodes[conn[0]].position;
            const end = nodes[conn[1]].position;
            const color = (conn[2] === 'faded') ? 0x666666 : 0xffffff;
            const arrow = createArrow(start, end, color);
            if (arrow) scene.add(arrow);
        });

        // --- Logic ---
        let currentIndex = -1;
        let camTarget = new THREE.Vector3();
        let controlsTarget = new THREE.Vector3();

        function updateStep(index) {
            currentIndex = index;
            const step = TOUR_STEPS[index];
            const phase = PHASES[step.phase];

            // UI
            document.getElementById('step-title').innerText = step.title;
            document.getElementById('step-desc').innerText = step.desc;
            const phaseEl = document.getElementById('step-phase');
            phaseEl.innerText = phase.name;
            phaseEl.style.color = phase.hex;
            document.getElementById('info-card').style.borderLeftColor = phase.hex;
            document.getElementById('btn-next').style.borderColor = phase.hex;
            document.getElementById('btn-next').style.color = phase.hex;

            // Highlight Legend
            ['setup', 'comm', 'ops', 'end'].forEach(p => {
                document.getElementById(`leg-${p}`).classList.remove('legend-active');
            });
            document.getElementById(`leg-${step.phase}`).classList.add('legend-active');

            // Nav State
            document.getElementById('btn-prev').disabled = (index === 0);
            document.getElementById('btn-next').disabled = (index === TOUR_STEPS.length - 1);

            // Camera Target
            const nodePos = nodes[step.id].position;
            camTarget.set(nodePos.x, 10, nodePos.z + 15);
            controlsTarget.copy(nodePos);
        }

        document.getElementById('btn-next').addEventListener('click', () => {
            if (currentIndex < TOUR_STEPS.length - 1) updateStep(currentIndex + 1);
        });

        document.getElementById('btn-prev').addEventListener('click', () => {
            if (currentIndex > 0) updateStep(currentIndex - 1);
        });

        // Loop
        function animate() {
            requestAnimationFrame(animate);
            if (currentIndex !== -1) {
                camera.position.lerp(camTarget, 0.05);
                controls.target.lerp(controlsTarget, 0.05);

                // Bobbing
                const activeId = TOUR_STEPS[currentIndex].id;
                nodes[activeId].position.y = 2 + Math.sin(Date.now() * 0.005) * 0.3;
            }
            controls.update();
            renderer.render(scene, camera);
        }
        animate();

        // Init
        updateStep(0);

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

    </script>
</body>

</html>